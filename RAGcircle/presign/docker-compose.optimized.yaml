services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmqq
    ports:
      - "127.0.0.1:5676:5672"
      - "15676:15672"
      - "1883:1883"
      - "15675:15675"
    command: >
      bash -lc "rabbitmq-plugins enable --offline rabbitmq_mqtt rabbitmq_web_mqtt &&
                exec rabbitmq-server"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
    networks:
      - rustfs-net
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rustfs:
    image: rustfs/rustfs:1.0.0-alpha.76
    command: /data1 /data2 /data3 /data4  # Multiple volumes for parallel writes
    user: "0:0"
    ports:
      - "127.0.0.1:9004:9000"
      - "127.0.0.1:9005:9001"
    depends_on:
      rabbitmq:
        condition: service_healthy
    networks:
      - rustfs-net
    
    # ========================================
    # PERFORMANCE OPTIMIZATIONS
    # ========================================
    
    # Resource Limits - Give rustfs plenty of resources
    deploy:
      resources:
        limits:
          cpus: '8.0'        # Adjust based on your host CPU count
          memory: 16G        # More memory = better caching
        reservations:
          cpus: '4.0'
          memory: 8G
    
    # Volumes - Use multiple mount points for parallel I/O
    volumes:
      - type: bind
        source: ./data/vol1
        target: /data1
        bind:
          propagation: shared
      - type: bind
        source: ./data/vol2
        target: /data2
        bind:
          propagation: shared
      - type: bind
        source: ./data/vol3
        target: /data3
        bind:
          propagation: shared
      - type: bind
        source: ./data/vol4
        target: /data4
        bind:
          propagation: shared
    
    environment:
      RUSTFS_ACCESS_KEY: rustfs
      RUSTFS_SECRET_KEY: password
      RUSTFS_REGION: eu-central
      
      # ========================================
      # PERFORMANCE TUNING ENVIRONMENT VARIABLES
      # ========================================
      
      # API Configuration - Increase concurrency limits
      RUSTFS_API_REQUESTS_MAX: "10000"              # Max concurrent API requests
      RUSTFS_API_REQUESTS_DEADLINE: "30s"           # Request timeout
      RUSTFS_API_CORS_ALLOW_ORIGIN: "*"
      
      # Storage Configuration - Optimize write/read behavior
      RUSTFS_STORAGE_CLASS: "STANDARD"              # Standard storage class
      RUSTFS_CACHE_DRIVES: "4"                      # Number of drives for caching
      RUSTFS_CACHE_EXCLUDE: ""                      # Don't exclude anything from cache
      RUSTFS_CACHE_QUOTA: "80"                      # Use 80% of disk for cache
      RUSTFS_CACHE_AFTER: "0"                       # Cache immediately
      RUSTFS_CACHE_WATERMARK_LOW: "70"              # Start eviction at 70%
      RUSTFS_CACHE_WATERMARK_HIGH: "90"             # Aggressive eviction at 90%
      
      # Memory and Buffer Tuning
      RUSTFS_API_READWRITE_BUFFER_SIZE: "4194304"   # 4MB buffer (larger = better for big files)
      
      # Connection Pool Optimization
      RUSTFS_API_ROOT_ACCESS: "on"                  # Enable if needed
      
      # Logging - Reduce for performance testing
      # RUSTFS_LOG_LEVEL: "WARN"                    # Less verbose logging (uncomment for prod)
      
      # MQTT Notification Configuration
      RUSTFS_NOTIFY_MQTT_ENABLE_primary: "on"
      RUSTFS_NOTIFY_MQTT_BROKER_primary: "tcp://rabbitmqq:1883"
      RUSTFS_NOTIFY_MQTT_TOPIC_primary: "rustfs/events"
      RUSTFS_NOTIFY_MQTT_QOS_primary: "1"
      RUSTFS_NOTIFY_MQTT_USERNAME_primary: "admin"
      RUSTFS_NOTIFY_MQTT_PASSWORD_primary: "admin"
      RUSTFS_NOTIFY_MQTT_KEEP_ALIVE_INTERVAL: "30s"
      RUSTFS_NOTIFY_MQTT_QUEUE_DIR: "/tmp/rustfs-mqtt-queue"
      RUSTFS_NOTIFY_MQTT_QUEUE_LIMIT: "100000"      # Large queue for high throughput
    
    # Security options for better performance
    security_opt:
      - no-new-privileges:true
    
    # Use tmpfs for temporary data (if available memory allows)
    tmpfs:
      - /tmp:size=2G,mode=1777
    
    # Disable unnecessary security features in dev/test
    # privileged: true  # Use only if you need host-level optimizations

networks:
  rustfs-net:
    driver: bridge
    driver_opts:
      com.docker.network.driver.mtu: 9000  # Jumbo frames if your network supports it


